input:
  label: "mqtt_in"
  mqtt:
    urls:
      - "mqtt://mqtt_broker:1883"
    client_id: "kafka-hydration"
    keepalive: 60
    clean_session: true
    topics:
      - "pohl-industries/+/machines/+/telemetry/status/state"

pipeline:
  processors:
    - mapping: |
        root.timestamp = this.timestamp
        root.machine_status = this.value
    - branch:
        request_map: 'root.key = meta("mqtt_topic").split("/").3'
        processors:
          - redis:
              url: "redis://redis_container:6379"
              command: hmget
              args_mapping: 'root = [ this.key, "name", "plant", "serialNumber", "spindleSpeed", "phase", "state" ]'
        result_map: |
          root.name = this.0
          root.plant = this.1
          root.serial_number = this.2
          root.spindle_speed = this.3
          root.phase = this.4
          root.state = this.5


output:
  label: "kafka_out"
  kafka:
    addresses:
      - kafka_broker:9092
    topic: "opcua.machines.status"
    key: '${! meta("mqtt_topic") }'
    client_id: "mqtt-to-kafka"
    batching:
      count: 50
      period: 1s

logger:
  level: INFO
  format: logfmt
